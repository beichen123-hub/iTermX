name: Build Android APK

on:
  push:
    branches: [ "master" ]
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 下载仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 安装 Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. 安装 pnpm
      - name: Install pnpm
        run: npm install -g pnpm

      # 4. 安装项目所有依赖 (前端 + Tauri)
      - name: Install dependencies
        run: pnpm install

      # 5. 设置 Rust 环境 (添加安卓编译目标)
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android, armv7-linux-androideabi, x86_64-linux-android, i686-linux-android

      # 6. 设置 Rust 缓存 (加速以后的编译)
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"

      # 7. 设置 Java (安卓编译必须)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 8. 设置 Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 9. 关键：初始化并编译安卓项目
      # 这里先运行 init 生成 gen/android 目录，再运行 build
      - name: Initialize and Build Android
        run: |
          # 安装必要的构建工具
          sudo apt-get update && sudo apt-get install -y perl make build-essential
          
          pnpm tauri android init
          
          # 设置 NDK 路径
          export ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/25.2.9519653
          
          # 关键补丁：为 OpenSSL 交叉编译手动指定编译器路径
          # 这能防止 openssl-src 在执行 make 时迷路
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          
          # 执行编译
          pnpm tauri android build --debug

      # 10. 上传生成的 APK 文件
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: iTermX-Debug-APK
          path: src-tauri/gen/android/app/build/outputs/apk/debug/*.apk
